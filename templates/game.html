{% extends "base.html" %}

{% block title %}Game - Spades Score Keeper{% endblock %}

{% block subtitle %}{{ game.team1_player1 }}/{{ game.team1_player2 }} vs {{ game.team2_player1 }}/{{ game.team2_player2 }}{% endblock %}

{% block datetime %}{{ game.created_date | datetime }}{% endblock %}

{% block content %}
{{ team_scores(game) }}

    <!-- Total Differential Display -->
    {% set team1_display = game.team1_final_score | score_with_bags(game.team1_bags) %}
    {% set team2_display = game.team2_final_score | score_with_bags(game.team2_bags) %}
    {% if team1_display != team2_display %}
    <div class="text-center mb-6">
        <div class="inline-block bg-gray-100 rounded-full px-4 py-2 text-sm font-medium text-gray-700">
            {% if team1_display > team2_display %}
            <span class="text-blue-600">{{ game.team1_player1 }}/{{ game.team1_player2 }}</span> leads by
            <span class="font-bold text-blue-800">{{ team1_display - team2_display }}</span> points
            {% else %}
            <span class="text-purple-600">{{ game.team2_player1 }}/{{ game.team2_player2 }}</span> leads by
            <span class="font-bold text-purple-800">{{ team2_display - team1_display }}</span> points
            {% endif %}
        </div>
    </div>
    {% elif team1_display == team2_display and team1_display > 0 %}
    <div class="text-center mb-6">
        <div class="inline-block bg-gray-100 rounded-full px-4 py-2 text-sm font-medium text-gray-700">
            Game is tied at {{ team1_display }} points
        </div>
    </div>
    {% endif %}

    <!-- Define completed_rounds for use throughout template -->
    {% set completed_rounds = rounds | rejectattr('team1_actual', 'equalto', none) | list %}

    {% if game.status == 'completed' %}
    <div class="bg-green-50 rounded-lg border border-green-200 p-6">
        <div class="text-center mb-4">
            <h2 class="text-2xl font-bold text-green-800 mb-2">üèÜ 
                {% if game.winner == 'Team 1' %}
                    {{ game.team1_player1 }} & {{ game.team1_player2 }} Win!
                {% elif game.winner == 'Team 2' %}
                    {{ game.team2_player1 }} & {{ game.team2_player2 }} Win!
                {% else %}
                    {{ game.winner }} Win!
                {% endif %}
            </h2>
            <p class="text-green-600">Game completed on {{ game.completed_date | simple_datetime }}</p>
        </div>
        
        <!-- Game Stats -->
        {% set total_rounds = completed_rounds | length %}
        
        <!-- Calculate stats using filters instead of loops -->
        {% set team1_wins = [] %}
        {% set team2_wins = [] %}
        {% set team1_positive = [] %}
        {% set team2_positive = [] %}
        {% set team1_negative = [] %}
        {% set team2_negative = [] %}
        {% set team1_nil_tries = [] %}
        {% set team2_nil_tries = [] %}
        {% set team1_nil_made = [] %}
        {% set team2_nil_made = [] %}
        
        {% for round in completed_rounds %}
            {% if round.team1_points|int > round.team2_points|int %}
                {% set _ = team1_wins.append(round) %}
            {% elif round.team2_points|int > round.team1_points|int %}
                {% set _ = team2_wins.append(round) %}
            {% endif %}
            
            {% if round.team1_points|int > 0 %}
                {% set _ = team1_positive.append(round.team1_points|int) %}
            {% elif round.team1_points|int < 0 %}
                {% set _ = team1_negative.append(round.team1_points|int) %}
            {% endif %}
            
            {% if round.team2_points|int > 0 %}
                {% set _ = team2_positive.append(round.team2_points|int) %}
            {% elif round.team2_points|int < 0 %}
                {% set _ = team2_negative.append(round.team2_points|int) %}
            {% endif %}
            
            {% if round.team1_bid.endswith('n') %}
                {% set _ = team1_nil_tries.append(round) %}
                {% if round.team1_actual|int == 0 %}
                    {% set _ = team1_nil_made.append(round) %}
                {% endif %}
            {% endif %}
            
            {% if round.team2_bid.endswith('n') %}
                {% set _ = team2_nil_tries.append(round) %}
                {% if round.team2_actual|int == 0 %}
                    {% set _ = team2_nil_made.append(round) %}
                {% endif %}
            {% endif %}
        {% endfor %}
        
        <div class="space-y-4">
            <div class="bg-white rounded-lg p-4 border border-green-200">
                <h4 class="font-semibold text-green-800 mb-3">üìä Game Stats</h4>
                <div class="grid grid-cols-2 gap-4 text-sm text-green-700">
                    <div class="flex justify-between">
                        <span>Total Rounds:</span>
                        <span class="font-medium">{{ total_rounds }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Score Margin:</span>
                        <span class="font-medium">{{ (game.team1_final_score - game.team2_final_score) | abs }}</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 border border-green-200">
                <h4 class="font-semibold text-green-800 mb-3">üéØ Game Breakdown</h4>
                <div class="grid grid-cols-2 gap-4 text-sm text-green-700">
                    <div class="space-y-1">
                        <div class="font-medium text-blue-800">{{ game.team1_player1 }}/{{ game.team1_player2 }}</div>
                        <div class="flex justify-between">
                            <span>Rounds Won:</span>
                            <span class="font-medium text-blue-600">{{ team1_wins|length }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Points Won:</span>
                            <span class="font-medium text-green-600">+{{ team1_positive|sum }}</span>
                        </div>
                        {% if team1_negative|sum < 0 %}
                        <div class="flex justify-between">
                            <span>Points Lost:</span>
                            <span class="font-medium text-red-600">{{ team1_negative|sum }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="space-y-1">
                        <div class="font-medium text-purple-800">{{ game.team2_player1 }}/{{ game.team2_player2 }}</div>
                        <div class="flex justify-between">
                            <span>Rounds Won:</span>
                            <span class="font-medium text-purple-600">{{ team2_wins|length }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Points Won:</span>
                            <span class="font-medium text-green-600">+{{ team2_positive|sum }}</span>
                        </div>
                        {% if team2_negative|sum < 0 %}
                        <div class="flex justify-between">
                            <span>Points Lost:</span>
                            <span class="font-medium text-red-600">{{ team2_negative|sum }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center">
        <!-- Check if there's a pending round (bids entered but no scores) -->
        {% set pending_round = rounds | selectattr('team1_actual', 'equalto', none) | first %}
        
        {% if pending_round %}
        <div class="spades-card rounded-xl p-6 mb-6 bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-200 shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                    <div class="flex items-center justify-center gap-3 mb-3">
                        <div class="text-center">
                            <h4 class="text-lg font-bold text-orange-800 mb-1">Round {{ pending_round.round_number }}</h4>
                            <p class="text-orange-600 text-sm font-medium">Bids are in! Ready to score</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-2 gap-3">
                        <div class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-orange-200">
                            <div class="text-xs font-medium text-blue-600 mb-1">{{ game.team1_player1 }} / {{ game.team1_player2 }}</div>
                            <div class="text-lg font-bold text-blue-800">{{ pending_round.team1_bid | format_bid_display }}</div>
                        </div>
                        <div class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-orange-200">
                            <div class="text-xs font-medium text-purple-600 mb-1">{{ game.team2_player1 }} / {{ game.team2_player2 }}</div>
                            <div class="text-lg font-bold text-purple-800">{{ pending_round.team2_bid | format_bid_display }}</div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-center md:justify-end">
                    <a href="{{ url_for('enter_scores', game_id=game.id) }}" class="bg-gradient-to-r from-orange-500 to-amber-500 text-white px-6 py-3 rounded-xl font-bold text-lg shadow-lg hover:from-orange-600 hover:to-amber-600 hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 btn-animate pulse-orange flex items-center gap-2">
                        <span class="text-xl">üìä</span>
                        <span>Enter Scores</span>
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <a href="{{ url_for('add_round', game_id=game.id) }}" class="bg-spades-success text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors btn-animate inline-block">
            üéØ Enter Bids
        </a>
        {% endif %}
    </div>
    {% endif %}


{% if completed_rounds %}
<div class="mt-8">
    <h3 class="text-lg font-bold text-gray-800 mb-4">üìä Round History</h3>
    {% for round in completed_rounds %}
    <div id="round{{ round.round_number }}" class="spades-card rounded-lg p-4 mb-3 transition-all duration-200">
        <div class="flex justify-between items-center mb-3">
            <div class="font-semibold text-gray-800">Round {{ round.round_number }}</div>
            <div>
                {% if round.team1_points > round.team2_points %}
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-medium">{{ game.team1_player1 }}/{{ game.team1_player2 }} +{{ round.team1_points - round.team2_points }}</span>
                {% elif round.team2_points > round.team1_points %}
                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm font-medium">{{ game.team2_player1 }}/{{ game.team2_player2 }} +{{ round.team2_points - round.team1_points }}</span>
                {% else %}
                <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm font-medium">Tie</span>
                {% endif %}
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div class="bg-blue-50 p-3 rounded border border-blue-200">
                <div class="text-center mb-4">
                    <div class="text-2xl font-bold {{ 'text-green-600' if round.team1_points > 0 else 'text-red-600' if round.team1_points < 0 else 'text-blue-900' }}">
                        {{ '+' if round.team1_points > 0 else '' }}{{ round.team1_points }}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Total: {{ round.team1_total | score_with_bags(round.team1_bags_total) }}</div>
                </div>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-blue-700">Bid: {{ round.team1_bid | format_bid_display }}</span>
                        <span class="text-blue-700">Made: {{ round.team1_actual }}</span>
                    </div>
                    {% set team1_breakdown = get_score_breakdown_detailed_template({
                        'bid_points': round.team1_bid_points,
                        'nil_bonus': round.team1_nil_bonus,
                        'blind_nil_bonus': round.team1_blind_nil_bonus,
                        'blind_bonus': round.team1_blind_bonus,
                        'bag_points': round.team1_bag_points,
                        'bag_penalty': round.team1_bag_penalty
                    }) %}
                    {% for item in team1_breakdown %}
                    <div class="flex justify-between">
                        <span>{{ item.label }}:</span>
                        <span class="{{ item.color }}">{{ item.value }}</span>
                    </div>
                    {% endfor %}
                    <div class="flex justify-between font-semibold border-t pt-1">
                        <span>Round total:</span>
                        <span class="{{ 'text-green-600' if round.team1_points > 0 else 'text-red-600' if round.team1_points < 0 else 'text-gray-900' }}">{{ '+' if round.team1_points > 0 else '' }}{{ round.team1_points }}</span>
                    </div>
                </div>
            </div>
            <div class="bg-purple-50 p-3 rounded border border-purple-200">
                <div class="text-center mb-4">
                    <div class="text-2xl font-bold {{ 'text-green-600' if round.team2_points > 0 else 'text-red-600' if round.team2_points < 0 else 'text-blue-900' }}">
                        {{ '+' if round.team2_points > 0 else '' }}{{ round.team2_points }}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Total: {{ round.team2_total | score_with_bags(round.team2_bags_total) }}</div>
                </div>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-purple-700">Bid: {{ round.team2_bid | format_bid_display }}</span>
                        <span class="text-purple-700">Made: {{ round.team2_actual }}</span>
                    </div>
                    {% set team2_breakdown = get_score_breakdown_detailed_template({
                        'bid_points': round.team2_bid_points,
                        'nil_bonus': round.team2_nil_bonus,
                        'blind_nil_bonus': round.team2_blind_nil_bonus,
                        'blind_bonus': round.team2_blind_bonus,
                        'bag_points': round.team2_bag_points,
                        'bag_penalty': round.team2_bag_penalty
                    }) %}
                    {% for item in team2_breakdown %}
                    <div class="flex justify-between">
                        <span>{{ item.label }}:</span>
                        <span class="{{ item.color }}">{{ item.value }}</span>
                    </div>
                    {% endfor %}
                    <div class="flex justify-between font-semibold border-t pt-1">
                        <span>Round total:</span>
                        <span class="{{ 'text-green-600' if round.team2_points > 0 else 'text-red-600' if round.team2_points < 0 else 'text-gray-900' }}">{{ '+' if round.team2_points > 0 else '' }}{{ round.team2_points }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Share Link Section -->
<div class="mt-8 bg-blue-50 rounded-lg border border-blue-200 p-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-blue-800">üîó Share This Game</h3>
    </div>
    <div class="space-y-4">
        <p class="text-sm text-blue-700">Share this code so others can follow the game:</p>
        <div class="flex flex-col sm:flex-row gap-3">
            <div class="bg-white border border-blue-300 rounded-lg p-4 text-center">
                <div class="text-xs text-blue-600 mb-1">Game Code</div>
                <div class="text-3xl font-bold text-blue-900 font-mono tracking-wider">{{ game.share_code }}</div>
                <div class="text-xs text-blue-600 mt-1">Visit {{ request.host_url }}view/{{ game.share_code }}</div>
            </div>
            <button onclick="copyShareUrl()" id="copyBtn"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center gap-2">
                <span class="text-sm">üìã</span>
                <span>Copy Link</span>
            </button>
        </div>
        <p class="text-xs text-blue-600">‚úì Spectators can view live scores but cannot make changes</p>
    </div>
</div>

<script>
function copyShareUrl() {
    const shareUrl = '{{ request.host_url }}view/{{ game.share_code }}';
    
    // Try modern clipboard API first
    if (navigator.clipboard) {
        navigator.clipboard.writeText(shareUrl).then(() => {
            showCopySuccess();
        }).catch(() => {
            // Fallback for older browsers
            fallbackCopy(shareUrl);
        });
    } else {
        fallbackCopy(shareUrl);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopySuccess();
    } catch (err) {
        console.error('Failed to copy: ', err);
    }
    
    document.body.removeChild(textArea);
}

function showCopySuccess() {
    const btn = document.getElementById('copyBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="text-sm">‚úì</span><span>Copied!</span>';
    btn.classList.add('bg-green-600');
    btn.classList.remove('bg-blue-600');
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('bg-green-600');
        btn.classList.add('bg-blue-600');
    }, 2000);
}
</script>

<!-- Game Settings Display -->
<div class="mt-8 border-t-2 pt-6">
    <div class="bg-gray-50 rounded-lg p-4 md:p-6 border border-gray-200">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">‚öôÔ∏è Game Settings</h3>
            <a href="{{ url_for('edit_game', game_id=game.id) }}" class="text-sm bg-gray-600 text-white px-3 py-2 rounded-lg font-medium hover:bg-gray-700 transition-colors">
                ‚úèÔ∏è Edit
            </a>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
            <!-- Scoring Settings -->
            <div class="bg-white rounded-lg p-3 border border-gray-200">
                <div class="font-medium text-gray-700 mb-2">üìä Scoring</div>
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Max score:</span>
                        <span class="font-medium">{{ game.max_score }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Nil penalty:</span>
                        <span class="font-medium">{{ game.nil_penalty }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Blind nil penalty:</span>
                        <span class="font-medium">{{ game.blind_nil_penalty }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Bag Settings -->
            <div class="bg-white rounded-lg p-3 border border-gray-200">
                <div class="font-medium text-gray-700 mb-2">üí∞ Bags</div>
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Penalty threshold:</span>
                        <span class="font-medium">{{ game.bag_penalty_threshold }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Penalty points:</span>
                        <span class="font-medium">-{{ game.bag_penalty_points }}</span>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<div class="text-center mt-6">
    <a href="{{ url_for('dashboard') }}" class="bg-spades-secondary text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-600 transition-colors btn-animate">
        ‚Üê Back to Dashboard
    </a>
</div>

{% endblock %}