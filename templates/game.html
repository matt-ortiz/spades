{% extends "base.html" %}

{% block title %}Game - Spades Score Keeper{% endblock %}

{% block subtitle %}{{ game.team1_player1 }}/{{ game.team1_player2 }} vs {{ game.team2_player1 }}/{{ game.team2_player2 }}{% endblock %}

{% block datetime %}{{ game.created_date | datetime }}{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 text-center border border-blue-200">
            <div class="text-sm font-medium text-blue-800 mb-2">{{ game.team1_player1 }} & {{ game.team1_player2 }}</div>
            <div class="text-3xl font-bold text-blue-900">{{ game.team1_final_score }}</div>
            {% if game.team1_bags > 0 %}
            <div class="text-sm text-yellow-600 mt-1">{{ game.team1_bags }} bags</div>
            {% endif %}
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 text-center border border-purple-200">
            <div class="text-sm font-medium text-purple-800 mb-2">{{ game.team2_player1 }} & {{ game.team2_player2 }}</div>
            <div class="text-3xl font-bold text-purple-900">{{ game.team2_final_score }}</div>
            {% if game.team2_bags > 0 %}
            <div class="text-sm text-yellow-600 mt-1">{{ game.team2_bags }} bags</div>
            {% endif %}
        </div>
    </div>

    <!-- Total Differential Display -->
    {% if game.team1_final_score != game.team2_final_score %}
    <div class="text-center mb-6">
        <div class="inline-block bg-gray-100 rounded-full px-4 py-2 text-sm font-medium text-gray-700">
            {% if game.team1_final_score > game.team2_final_score %}
            <span class="text-blue-600">{{ game.team1_player1 }}/{{ game.team1_player2 }}</span> leads by 
            <span class="font-bold text-blue-800">{{ game.team1_final_score - game.team2_final_score }}</span> points
            {% else %}
            <span class="text-purple-600">{{ game.team2_player1 }}/{{ game.team2_player2 }}</span> leads by 
            <span class="font-bold text-purple-800">{{ game.team2_final_score - game.team1_final_score }}</span> points
            {% endif %}
        </div>
    </div>
    {% elif game.team1_final_score == game.team2_final_score and game.team1_final_score > 0 %}
    <div class="text-center mb-6">
        <div class="inline-block bg-gray-100 rounded-full px-4 py-2 text-sm font-medium text-gray-700">
            Game is tied at {{ game.team1_final_score }} points
        </div>
    </div>
    {% endif %}

    {% if game.status == 'completed' %}
    <div class="text-center py-6 bg-green-50 rounded-lg border border-green-200">
        <h2 class="text-2xl font-bold text-green-800 mb-2">🏆 {{ game.winner }} Wins!</h2>
        <p class="text-green-600">Game completed on {{ game.completed_date.strftime('%m/%d/%Y at %I:%M %p') }}</p>
    </div>
    {% else %}
    <div class="text-center">
        <!-- Check if there's a pending round (bids entered but no scores) -->
        {% set pending_round = rounds | selectattr('team1_actual', 'equalto', none) | first %}
        
        {% if pending_round %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="font-semibold text-yellow-800">Round {{ pending_round.round_number }} - Bids Entered</h4>
                    <p class="text-yellow-700 text-sm">{{ game.team1_player1 }}/{{ game.team1_player2 }}: {{ pending_round.team1_bid }} | {{ game.team2_player1 }}/{{ game.team2_player2 }}: {{ pending_round.team2_bid }}</p>
                </div>
                <a href="{{ url_for('enter_scores', game_id=game.id) }}" class="bg-spades-warning text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition-colors btn-animate">
                    📊 Enter Scores
                </a>
            </div>
        </div>
        {% else %}
        <a href="{{ url_for('add_round', game_id=game.id) }}" class="bg-spades-success text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors btn-animate inline-block">
            🎯 Enter Bids
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

{% set completed_rounds = rounds | rejectattr('team1_actual', 'equalto', none) | list %}

{% if completed_rounds %}
<div class="mt-8">
    <h3 class="text-lg font-bold text-gray-800 mb-4">📊 Round History</h3>
    {% for round in completed_rounds %}
    <div class="spades-card rounded-lg p-4 mb-3 transition-all duration-200">
        <div class="flex justify-between items-center mb-3">
            <div class="font-semibold text-gray-800">Round {{ round.round_number }}</div>
            <div>
                {% if round.team1_points > round.team2_points %}
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-medium">{{ game.team1_player1 }}/{{ game.team1_player2 }} +{{ round.team1_points - round.team2_points }}</span>
                {% elif round.team2_points > round.team1_points %}
                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm font-medium">{{ game.team2_player1 }}/{{ game.team2_player2 }} +{{ round.team2_points - round.team1_points }}</span>
                {% else %}
                <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm font-medium">Tie</span>
                {% endif %}
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div class="bg-blue-50 p-3 rounded border border-blue-200">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-blue-700">Bid {{ round.team1_bid }}</span>
                    <span class="text-blue-700">Made {{ round.team1_actual }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <div class="text-lg font-bold {{ 'text-green-600' if round.team1_points > 0 else 'text-red-600' if round.team1_points < 0 else 'text-blue-900' }}">
                        {{ '+' if round.team1_points > 0 else '' }}{{ round.team1_points }}
                    </div>
                    <span class="text-xs text-blue-700">Total {{ round.team1_total }}</span>
                </div>
                {% if round.team1_bags_earned > 0 %}
                <div class="text-xs text-yellow-600 mt-1">+{{ round.team1_bags_earned }} bags</div>
                {% endif %}
            </div>
            <div class="bg-purple-50 p-3 rounded border border-purple-200">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-purple-700">Bid {{ round.team2_bid }}</span>
                    <span class="text-purple-700">Made {{ round.team2_actual }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <div class="text-lg font-bold {{ 'text-green-600' if round.team2_points > 0 else 'text-red-600' if round.team2_points < 0 else 'text-purple-900' }}">
                        {{ '+' if round.team2_points > 0 else '' }}{{ round.team2_points }}
                    </div>
                    <span class="text-xs text-purple-700">Total {{ round.team2_total }}</span>
                </div>
                {% if round.team2_bags_earned > 0 %}
                <div class="text-xs text-yellow-600 mt-1">+{{ round.team2_bags_earned }} bags</div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="text-center mt-8">
    <a href="{{ url_for('dashboard') }}" class="bg-spades-secondary text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-600 transition-colors btn-animate">
        ← Back to Dashboard
    </a>
</div>
{% endblock %}