{% extends "base.html" %}

{% block title %}Spectating Game - Spades Score Keeper{% endblock %}

{% block subtitle %}{{ game.team1_player1 }}/{{ game.team1_player2 }} vs {{ game.team2_player1 }}/{{ game.team2_player2 }} (Spectator View){% endblock %}

{% block datetime %}{{ game.created_date | datetime }}{% endblock %}

{% block content %}
{{ team_scores(game) }}

    <!-- Spectator Notice -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <div class="flex items-center gap-2">
            <span class="text-yellow-600 text-lg">üëÄ</span>
            <div>
                <h4 class="font-semibold text-yellow-800">Spectator View</h4>
                <p class="text-sm text-yellow-700">You're viewing this game as a spectator. Scores update automatically.</p>
            </div>
        </div>
    </div>

    <!-- Total Differential Display -->
    {% if game.team1_final_score != game.team2_final_score %}
    <div class="text-center mb-6">
        <div class="inline-block bg-gray-100 rounded-full px-4 py-2 text-sm font-medium text-gray-700">
            {% if game.team1_final_score > game.team2_final_score %}
            <span class="text-blue-600">{{ game.team1_player1 }}/{{ game.team1_player2 }}</span> leads by 
            <span class="font-bold text-blue-800">{{ game.team1_final_score - game.team2_final_score }}</span> points
            {% else %}
            <span class="text-purple-600">{{ game.team2_player1 }}/{{ game.team2_player2 }}</span> leads by 
            <span class="font-bold text-purple-800">{{ game.team2_final_score - game.team1_final_score }}</span> points
            {% endif %}
        </div>
    </div>
    {% elif game.team1_final_score == game.team2_final_score and game.team1_final_score > 0 %}
    <div class="text-center mb-6">
        <div class="inline-block bg-gray-100 rounded-full px-4 py-2 text-sm font-medium text-gray-700">
            Game is tied at {{ game.team1_final_score }} points
        </div>
    </div>
    {% endif %}

    <!-- Define completed_rounds for use throughout template -->
    {% set completed_rounds = rounds | rejectattr('team1_actual', 'equalto', none) | list %}

    {% if game.status == 'completed' %}
    <div class="bg-green-50 rounded-lg border border-green-200 p-6">
        <div class="text-center mb-4">
            <h2 class="text-2xl font-bold text-green-800 mb-2">üèÜ 
                {% if game.winner == 'Team 1' %}
                    {{ game.team1_player1 }} & {{ game.team1_player2 }} Win!
                {% elif game.winner == 'Team 2' %}
                    {{ game.team2_player1 }} & {{ game.team2_player2 }} Win!
                {% else %}
                    {{ game.winner }} Win!
                {% endif %}
            </h2>
            <p class="text-green-600">Game completed on {{ game.completed_date | simple_datetime }}</p>
        </div>
        
        <!-- Game Stats -->
        {% set total_rounds = completed_rounds | length %}
        
        <!-- Calculate stats using filters instead of loops -->
        {% set team1_wins = [] %}
        {% set team2_wins = [] %}
        {% set team1_positive = [] %}
        {% set team2_positive = [] %}
        {% set team1_negative = [] %}
        {% set team2_negative = [] %}
        {% set team1_nil_tries = [] %}
        {% set team2_nil_tries = [] %}
        {% set team1_nil_made = [] %}
        {% set team2_nil_made = [] %}
        
        {% for round in completed_rounds %}
            {% if round.team1_points|int > round.team2_points|int %}
                {% set _ = team1_wins.append(round) %}
            {% elif round.team2_points|int > round.team1_points|int %}
                {% set _ = team2_wins.append(round) %}
            {% endif %}
            
            {% if round.team1_points|int > 0 %}
                {% set _ = team1_positive.append(round.team1_points|int) %}
            {% elif round.team1_points|int < 0 %}
                {% set _ = team1_negative.append(round.team1_points|int) %}
            {% endif %}
            
            {% if round.team2_points|int > 0 %}
                {% set _ = team2_positive.append(round.team2_points|int) %}
            {% elif round.team2_points|int < 0 %}
                {% set _ = team2_negative.append(round.team2_points|int) %}
            {% endif %}
            
            {% if round.team1_bid.endswith('n') %}
                {% set _ = team1_nil_tries.append(round) %}
                {% if round.team1_actual|int == 0 %}
                    {% set _ = team1_nil_made.append(round) %}
                {% endif %}
            {% endif %}
            
            {% if round.team2_bid.endswith('n') %}
                {% set _ = team2_nil_tries.append(round) %}
                {% if round.team2_actual|int == 0 %}
                    {% set _ = team2_nil_made.append(round) %}
                {% endif %}
            {% endif %}
        {% endfor %}
        
        <div class="space-y-4">
            <div class="bg-white rounded-lg p-4 border border-green-200">
                <h4 class="font-semibold text-green-800 mb-3">üìä Game Stats</h4>
                <div class="grid grid-cols-2 gap-4 text-sm text-green-700">
                    <div class="flex justify-between">
                        <span>Total Rounds:</span>
                        <span class="font-medium">{{ total_rounds }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Score Margin:</span>
                        <span class="font-medium">{{ (game.team1_final_score - game.team2_final_score) | abs }}</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg p-4 border border-green-200">
                <h4 class="font-semibold text-green-800 mb-3">üéØ Game Breakdown</h4>
                <div class="grid grid-cols-2 gap-4 text-sm text-green-700">
                    <div class="space-y-1">
                        <div class="font-medium text-blue-800">{{ game.team1_player1 }}/{{ game.team1_player2 }}</div>
                        <div class="flex justify-between">
                            <span>Rounds Won:</span>
                            <span class="font-medium text-blue-600">{{ team1_wins|length }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Points Won:</span>
                            <span class="font-medium text-green-600">+{{ team1_positive|sum }}</span>
                        </div>
                        {% if team1_negative|sum < 0 %}
                        <div class="flex justify-between">
                            <span>Points Lost:</span>
                            <span class="font-medium text-red-600">{{ team1_negative|sum }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="space-y-1">
                        <div class="font-medium text-purple-800">{{ game.team2_player1 }}/{{ game.team2_player2 }}</div>
                        <div class="flex justify-between">
                            <span>Rounds Won:</span>
                            <span class="font-medium text-purple-600">{{ team2_wins|length }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Points Won:</span>
                            <span class="font-medium text-green-600">+{{ team2_positive|sum }}</span>
                        </div>
                        {% if team2_negative|sum < 0 %}
                        <div class="flex justify-between">
                            <span>Points Lost:</span>
                            <span class="font-medium text-red-600">{{ team2_negative|sum }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center">
        <!-- Check if there's a pending round (bids entered but no scores) -->
        {% set pending_round = rounds | selectattr('team1_actual', 'equalto', none) | first %}
        
        {% if pending_round %}
        <div class="spades-card rounded-xl p-6 mb-6 bg-gradient-to-br from-orange-50 to-amber-50 border-2 border-orange-200 shadow-lg">
            <div class="flex flex-col gap-4">
                <div class="flex-1">
                    <div class="flex items-center justify-center gap-3 mb-3">
                        <div class="text-center">
                            <h4 class="text-lg font-bold text-orange-800 mb-1">Round {{ pending_round.round_number }}</h4>
                            <p class="text-orange-600 text-sm font-medium">Waiting for scores...</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-2 gap-3">
                        <div class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-orange-200">
                            <div class="text-xs font-medium text-blue-600 mb-1">{{ game.team1_player1 }} / {{ game.team1_player2 }}</div>
                            <div class="text-lg font-bold text-blue-800">{{ pending_round.team1_bid | format_bid_display }}</div>
                        </div>
                        <div class="bg-white/80 backdrop-blur-sm rounded-lg p-3 border border-orange-200">
                            <div class="text-xs font-medium text-purple-600 mb-1">{{ game.team2_player1 }} / {{ game.team2_player2 }}</div>
                            <div class="text-lg font-bold text-purple-800">{{ pending_round.team2_bid | format_bid_display }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
            <p class="text-gray-600">Waiting for next round to begin...</p>
        </div>
        {% endif %}
    </div>
    {% endif %}


{% if completed_rounds %}
<div class="mt-8">
    <h3 class="text-lg font-bold text-gray-800 mb-4">üìä Round History</h3>
    {% for round in completed_rounds %}
    <div id="round{{ round.round_number }}" class="spades-card rounded-lg p-4 mb-3 transition-all duration-200">
        <div class="flex justify-between items-center mb-3">
            <div class="font-semibold text-gray-800">Round {{ round.round_number }}</div>
            <div>
                {% if round.team1_points > round.team2_points %}
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-medium">{{ game.team1_player1 }}/{{ game.team1_player2 }} +{{ round.team1_points - round.team2_points }}</span>
                {% elif round.team2_points > round.team1_points %}
                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm font-medium">{{ game.team2_player1 }}/{{ game.team2_player2 }} +{{ round.team2_points - round.team1_points }}</span>
                {% else %}
                <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm font-medium">Tie</span>
                {% endif %}
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div class="bg-blue-50 p-3 rounded border border-blue-200">
                <div class="text-center mb-4">
                    <div class="text-2xl font-bold {{ 'text-green-600' if round.team1_points > 0 else 'text-red-600' if round.team1_points < 0 else 'text-blue-900' }}">
                        {{ '+' if round.team1_points > 0 else '' }}{{ round.team1_points }}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Total: {{ round.team1_total }}</div>
                </div>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-blue-700">Bid: {{ round.team1_bid | format_bid_display }}</span>
                        <span class="text-blue-700">Made: {{ round.team1_actual }}</span>
                    </div>
                    {% set team1_breakdown = get_score_breakdown_detailed_template({
                        'bid_points': round.team1_bid_points,
                        'nil_bonus': round.team1_nil_bonus,
                        'blind_nil_bonus': round.team1_blind_nil_bonus,
                        'blind_bonus': round.team1_blind_bonus,
                        'bag_points': round.team1_bag_points,
                        'bag_penalty': round.team1_bag_penalty
                    }) %}
                    {% for item in team1_breakdown %}
                    <div class="flex justify-between">
                        <span>{{ item.label }}:</span>
                        <span class="{{ item.color }}">{{ item.value }}</span>
                    </div>
                    {% endfor %}
                    <div class="flex justify-between font-semibold border-t pt-1">
                        <span>Round total:</span>
                        <span class="{{ 'text-green-600' if round.team1_points > 0 else 'text-red-600' if round.team1_points < 0 else 'text-gray-900' }}">{{ '+' if round.team1_points > 0 else '' }}{{ round.team1_points }}</span>
                    </div>
                </div>
            </div>
            <div class="bg-purple-50 p-3 rounded border border-purple-200">
                <div class="text-center mb-4">
                    <div class="text-2xl font-bold {{ 'text-green-600' if round.team2_points > 0 else 'text-red-600' if round.team2_points < 0 else 'text-blue-900' }}">
                        {{ '+' if round.team2_points > 0 else '' }}{{ round.team2_points }}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Total: {{ round.team2_total }}</div>
                </div>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-purple-700">Bid: {{ round.team2_bid | format_bid_display }}</span>
                        <span class="text-purple-700">Made: {{ round.team2_actual }}</span>
                    </div>
                    {% set team2_breakdown = get_score_breakdown_detailed_template({
                        'bid_points': round.team2_bid_points,
                        'nil_bonus': round.team2_nil_bonus,
                        'blind_nil_bonus': round.team2_blind_nil_bonus,
                        'blind_bonus': round.team2_blind_bonus,
                        'bag_points': round.team2_bag_points,
                        'bag_penalty': round.team2_bag_penalty
                    }) %}
                    {% for item in team2_breakdown %}
                    <div class="flex justify-between">
                        <span>{{ item.label }}:</span>
                        <span class="{{ item.color }}">{{ item.value }}</span>
                    </div>
                    {% endfor %}
                    <div class="flex justify-between font-semibold border-t pt-1">
                        <span>Round total:</span>
                        <span class="{{ 'text-green-600' if round.team2_points > 0 else 'text-red-600' if round.team2_points < 0 else 'text-gray-900' }}">{{ '+' if round.team2_points > 0 else '' }}{{ round.team2_points }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Game Settings Display (Read-only for spectators) -->
<div class="mt-8 border-t-2 pt-6">
    <div class="bg-gray-50 rounded-lg p-4 md:p-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">‚öôÔ∏è Game Settings</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
            <!-- Scoring Settings -->
            <div class="bg-white rounded-lg p-3 border border-gray-200">
                <div class="font-medium text-gray-700 mb-2">üìä Scoring</div>
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Max score:</span>
                        <span class="font-medium">{{ game.max_score }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Nil penalty:</span>
                        <span class="font-medium">{{ game.nil_penalty }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Blind nil penalty:</span>
                        <span class="font-medium">{{ game.blind_nil_penalty }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Bag Settings -->
            <div class="bg-white rounded-lg p-3 border border-gray-200">
                <div class="font-medium text-gray-700 mb-2">üí∞ Bags</div>
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Penalty threshold:</span>
                        <span class="font-medium">{{ game.bag_penalty_threshold }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Penalty points:</span>
                        <span class="font-medium">-{{ game.bag_penalty_points }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="text-center mt-6">
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
        <p class="text-sm text-blue-700">üîó This is a spectator view. Page refreshes automatically to show latest scores.</p>
    </div>
</div>

<!-- Auto-refresh for spectators -->
<script>
    // Refresh the page every 30 seconds to show latest scores
    setTimeout(function() {
        location.reload();
    }, 30000);
</script>

{% endblock %}